#!/bin/bash
#set -x
dir=$1
dir=${dir%/}

[[ -z $dir ]] && {
    echo "USAGE: $0 <datadir>"
    exit -1
}

resfile=${dir}.csv
echo path,server,client,protocol,role,mtu,bufsize,winsize,bitrate,par,affin,bw,units > $resfile
ls $dir/iperf_* | while read file; do
    name=${file%%.log}
    IFS=_ read pgm prot role mtu bufsize winsize bitrate par affin srv clt <<< $name
    if [[ $role == srv ]]; then
	res=$(tail -1 $file)
    else
	res=$(grep 'sec.*sender$' $file | tail -1)
    fi
    res=${res##*Bytes}
    res=${res%%/sec*}
    read bw units <<< $res
    units=${units}/sec
    echo $file,$srv,$clt,$prot,$role,$mtu,$bufsize,$winsize,$bitrate,$par,$affin,$bw,$units
done >> $resfile


